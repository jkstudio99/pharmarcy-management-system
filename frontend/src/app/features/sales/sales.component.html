<p-toast />

<div class="page-header">
  <div>
    <h1 class="text-title-1">{{ 'SALES.TITLE' | translate }}</h1>
    <p class="text-subhead" style="color:var(--color-text-secondary)">{{ 'SALES.SUBTITLE' | translate }}</p>
  </div>
  @if (auth.isPharmacistUp()) {
    <p-button [label]="'SALES.NEW_ORDER' | translate" icon="pi pi-plus" (onClick)="openCreate()" />
  }
</div>

<div class="table-card">
  <p-table [value]="orders()" [loading]="loading()" [lazy]="true"
           [totalRecords]="totalRecords()" [rows]="pageSize"
           [paginator]="true" [rowsPerPageOptions]="[10,20,50]"
           (onPage)="onPageChange($event)" [tableStyle]="{'min-width':'700px'}">
    <ng-template pTemplate="header">
      <tr>
        <th>{{ 'SALES.REF_NO' | translate }}</th>
        <th>{{ 'SALES.EMPLOYEE' | translate }}</th>
        <th>{{ 'SALES.CUSTOMER' | translate }}</th>
        <th style="text-align:right">{{ 'SALES.TOTAL' | translate }}</th>
        <th>{{ 'SALES.PAYMENT' | translate }}</th>
        <th>{{ 'SALES.DATE' | translate }}</th>
        <th style="text-align:center">{{ 'COMMON.ACTIONS' | translate }}</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-o>
      <tr>
        <td data-label="Ref No."><span class="ref-no">{{ o.referenceNo }}</span></td>
        <td data-label="Employee">{{ o.employeeName }}</td>
        <td data-label="Customer">{{ o.customerInfo || '—' }}</td>
        <td data-label="Total" style="text-align:right"><strong>฿{{ o.totalAmount.toFixed(2) }}</strong></td>
        <td data-label="Payment">
          <span class="badge badge-info">{{ o.paymentMethod }}</span>
        </td>
        <td data-label="Date">{{ o.createdAt | date:'dd MMM yyyy HH:mm' }}</td>
        <td data-label="Actions" style="text-align:center">
          <p-button icon="pi pi-eye" [text]="true" [rounded]="true" severity="secondary"
                    (onClick)="viewDetail(o)" [pTooltip]="'COMMON.VIEW_DETAILS' | translate" />
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr><td colspan="7" class="empty-msg">{{ 'COMMON.NO_DATA' | translate }}</td></tr>
    </ng-template>
  </p-table>
</div>

<!-- Create Order Dialog -->
<p-dialog [header]="'SALES.NEW_ORDER_TITLE' | translate" [(visible)]="showCreate"
          [modal]="true" [style]="{width:'600px'}" [draggable]="false" [resizable]="false">
  <div class="dialog-form">
    <div class="form-row">
      <div class="form-field">
        <label class="field-label">{{ 'SALES.CUSTOMER_INFO' | translate }}</label>
        <input pInputText [(ngModel)]="form.customerInfo" [placeholder]="'SALES.PH_CUSTOMER' | translate" />
      </div>
      <div class="form-field">
        <label class="field-label">{{ 'SALES.PAYMENT_METHOD' | translate }}</label>
        <p-select [options]="paymentOptions" [(ngModel)]="form.paymentMethod" />
      </div>
    </div>

    <div class="items-section">
      <div class="items-header">
        <label class="field-label">{{ 'SALES.ORDER_ITEMS' | translate }}</label>
        <p-button [label]="'SALES.ADD_ITEM' | translate" icon="pi pi-plus" [text]="true" size="small" (onClick)="addItem()" />
      </div>
      @for (item of items; track $index; let i = $index) {
        <div class="item-row">
          <div class="item-drug">
            <p-select [options]="medicineOptions()" [(ngModel)]="item.drugId"
                      [placeholder]="'SALES.PH_SELECT_DRUG' | translate" [filter]="true" [filterPlaceholder]="'SALES.PH_SEARCH' | translate" />
          </div>
          <div class="item-qty">
            <p-inputNumber [(ngModel)]="item.quantity" [min]="1" [showButtons]="true" />
          </div>
          <p-button icon="pi pi-times" [text]="true" [rounded]="true" severity="danger"
                    (onClick)="removeItem(i)" [disabled]="items.length === 1" />
        </div>
      }
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button [label]="'COMMON.CANCEL' | translate" severity="secondary" [outlined]="true" (onClick)="showCreate.set(false)" />
    <p-button [label]="'SALES.CREATE_ORDER' | translate" icon="pi pi-check" (onClick)="create()" [loading]="saving()" />
  </ng-template>
</p-dialog>

<!-- Order Detail Dialog -->
<p-dialog [header]="'SALES.ORDER_DETAILS' | translate" [(visible)]="showDetail"
          [modal]="true" [style]="{width:'560px'}" [draggable]="false">
  @if (selectedOrder()) {
    <div class="detail-header">
      <div><span class="field-label">{{ 'SALES.DETAIL_REFERENCE' | translate }}:</span> <span class="ref-no">{{ selectedOrder()!.referenceNo }}</span></div>
      <div><span class="field-label">{{ 'SALES.DETAIL_EMPLOYEE' | translate }}:</span> {{ selectedOrder()!.employeeName }}</div>
      <div><span class="field-label">{{ 'SALES.DETAIL_CUSTOMER' | translate }}:</span> {{ selectedOrder()!.customerInfo || '—' }}</div>
      <div><span class="field-label">{{ 'SALES.DETAIL_PAYMENT' | translate }}:</span> {{ selectedOrder()!.paymentMethod }}</div>
      <div><span class="field-label">{{ 'SALES.DETAIL_DATE' | translate }}:</span> {{ selectedOrder()!.createdAt | date:'dd MMM yyyy HH:mm' }}</div>
    </div>
    <p-table [value]="selectedOrder()!.items" styleClass="mt-4">
      <ng-template pTemplate="header">
        <tr>
          <th>{{ 'SALES.DRUG' | translate }}</th>
          <th>{{ 'SALES.BATCH' | translate }}</th>
          <th style="text-align:right">{{ 'SALES.QTY' | translate }}</th>
          <th style="text-align:right">{{ 'SALES.UNIT_PRICE' | translate }}</th>
          <th style="text-align:right">{{ 'SALES.LINE_TOTAL' | translate }}</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-item>
        <tr>
          <td>{{ item.drugName }}</td>
          <td><span class="ref-no">{{ item.batchNumber }}</span></td>
          <td style="text-align:right">{{ item.quantity }}</td>
          <td style="text-align:right">฿{{ item.unitPrice.toFixed(2) }}</td>
          <td style="text-align:right"><strong>฿{{ item.lineTotal.toFixed(2) }}</strong></td>
        </tr>
      </ng-template>
    </p-table>
    <div class="detail-total">
      {{ 'SALES.DETAIL_TOTAL' | translate }}: <strong>฿{{ selectedOrder()!.totalAmount.toFixed(2) }}</strong>
    </div>
  }
</p-dialog>
