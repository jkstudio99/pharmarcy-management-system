<p-toast />
<p-confirmDialog />

<div class="page-header">
  <div>
    <h1 class="text-title-1">{{ 'MEDICINES.TITLE' | translate }}</h1>
    <p class="text-subhead" style="color:var(--color-text-secondary)">{{ 'MEDICINES.SUBTITLE' | translate }}</p>
  </div>
  @if (isPharmacistUp()) {
    <p-button [label]="'MEDICINES.ADD' | translate" icon="pi pi-plus" (onClick)="openCreate()" />
  }
</div>

<!-- Filters -->
<div class="filter-bar">
  <div class="search-wrap">
    <i class="pi pi-search search-icon"></i>
    <input pInputText [(ngModel)]="search" (keyup.enter)="onSearch()"
           [placeholder]="'MEDICINES.PH_SEARCH' | translate" class="search-input" />
  </div>
  <p-select [options]="categoryOptions()" [(ngModel)]="selectedCategoryId"
            [placeholder]="'MEDICINES.PH_ALL_CATEGORIES' | translate" [showClear]="true"
            (onChange)="onSearch()" styleClass="filter-select" />
  <p-button icon="pi pi-refresh" severity="secondary" [outlined]="true"
            (onClick)="onSearch()" [pTooltip]="'COMMON.REFRESH' | translate" />
</div>

<!-- Table -->
<div class="table-card">
  <p-table [value]="medicines()" [loading]="loading()" [lazy]="true"
           [totalRecords]="totalRecords()" [rows]="pageSize"
           [paginator]="true" [rowsPerPageOptions]="[10,20,50]"
           (onPage)="onPageChange($event)"
           [tableStyle]="{'min-width':'700px'}" styleClass="p-datatable-sm">

    <ng-template pTemplate="header">
      <tr>
        <th style="width:56px"></th>
        <th>{{ 'MEDICINES.DRUG_NAME' | translate }}</th>
        <th>{{ 'MEDICINES.GENERIC_NAME' | translate }}</th>
        <th>{{ 'MEDICINES.CATEGORY' | translate }}</th>
        <th>{{ 'MEDICINES.UNIT' | translate }}</th>
        <th style="text-align:right">{{ 'MEDICINES.TOTAL_STOCK' | translate }}</th>
        <th style="text-align:center">{{ 'MEDICINES.STATUS' | translate }}</th>
        @if (isPharmacistUp()) { <th style="text-align:center">{{ 'COMMON.ACTIONS' | translate }}</th> }
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-m>
      <tr>
        <td>
          @if (m.imageUrl) {
            <img [src]="resolveImageUrl(m.imageUrl)" (error)="onThumbError($event)" alt="" class="drug-thumb" />
          } @else {
            <div class="drug-thumb-placeholder"><i class="pi pi-box"></i></div>
          }
        </td>
        <td data-label="Drug Name">
          <div class="drug-name">{{ m.drugName }}</div>
          @if (m.barcode) { <div class="barcode text-caption">{{ m.barcode }}</div> }
        </td>
        <td data-label="Generic Name">{{ m.genericName ?? '—' }}</td>
        <td data-label="Category">{{ m.categoryName ?? '—' }}</td>
        <td data-label="Unit">{{ m.unit ?? '—' }}</td>
        <td data-label="Stock" style="text-align:right">
          <span [class]="m.isLowStock ? 'stock-low' : 'stock-ok'">{{ m.totalStock }}</span>
        </td>
        <td data-label="Status" style="text-align:center">
          @if (m.isLowStock) {
            <span class="badge badge-warning">{{ 'MEDICINES.LOW_STOCK' | translate }}</span>
          } @else {
            <span class="badge badge-success">{{ 'MEDICINES.ACTIVE' | translate }}</span>
          }
        </td>
        @if (isPharmacistUp()) {
          <td data-label="Actions" style="text-align:center">
            <div class="action-btns">
              <p-button icon="pi pi-pencil" [text]="true" [rounded]="true" severity="secondary"
                        (onClick)="openEdit(m)" [pTooltip]="'COMMON.EDIT' | translate" />
              <p-button icon="pi pi-image" [text]="true" [rounded]="true" severity="info"
                        (onClick)="openImageUpload(m)" [pTooltip]="'COMMON.UPLOAD_IMAGE' | translate" />
              <p-button icon="pi pi-trash" [text]="true" [rounded]="true" severity="danger"
                        (onClick)="confirmDelete(m)" [pTooltip]="'COMMON.DEACTIVATE' | translate" />
            </div>
          </td>
        }
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr><td [attr.colspan]="isPharmacistUp() ? 8 : 7" class="empty-msg">{{ 'COMMON.NO_DATA' | translate }}</td></tr>
    </ng-template>
  </p-table>
</div>

<!-- Image Upload Dialog -->
<p-dialog [header]="'MEDICINES.UPLOAD_IMAGE' | translate" [(visible)]="showImageDialog"
          [modal]="true" [style]="{width:'420px'}" [draggable]="false" [resizable]="false">
  @if (imageTarget()) {
    <div class="upload-drug-name">{{ imageTarget()!.drugName }}</div>
  }
  <div class="upload-area">
    @if (imagePreview) {
      <img [src]="imagePreview" alt="preview" class="image-preview" />
    } @else {
      <div class="upload-placeholder">
        <i class="pi pi-image" style="font-size:40px;color:var(--color-text-tertiary)"></i>
        <p class="text-caption" style="color:var(--color-text-secondary)">{{ 'MEDICINES.NO_IMAGE' | translate }}</p>
      </div>
    }
  </div>
  <div class="upload-actions">
    <label class="upload-btn">
      <i class="pi pi-folder-open"></i>
      {{ 'MEDICINES.CHOOSE_FILE' | translate }}
      <input type="file" accept="image/*" (change)="onFileSelected($event)" hidden />
    </label>
    @if (selectedFile) {
      <span class="text-caption" style="color:var(--color-text-secondary)">{{ selectedFile.name }}</span>
    }
  </div>
  <ng-template pTemplate="footer">
    <p-button [label]="'COMMON.CANCEL' | translate" severity="secondary" [outlined]="true"
              (onClick)="showImageDialog.set(false)" />
    <p-button [label]="'MEDICINES.UPLOAD' | translate" icon="pi pi-upload"
              (onClick)="uploadImage()" [loading]="uploadingImage()" [disabled]="!selectedFile" />
  </ng-template>
</p-dialog>

<!-- Create/Edit Dialog -->
<p-dialog [header]="(editMode() ? 'MEDICINES.EDIT' : 'MEDICINES.ADD') | translate"
          [(visible)]="showDialog" [modal]="true" [style]="{width:'560px'}"
          [draggable]="false" [resizable]="false">
  <div class="dialog-form">
    <div class="form-row">
      <div class="form-field">
        <label class="field-label">{{ 'MEDICINES.DRUG_NAME' | translate }} *</label>
        <input pInputText [(ngModel)]="form.drugName" [placeholder]="'MEDICINES.PH_DRUG_NAME' | translate" />
      </div>
      <div class="form-field">
        <label class="field-label">{{ 'MEDICINES.GENERIC_NAME' | translate }}</label>
        <input pInputText [(ngModel)]="form.genericName" [placeholder]="'MEDICINES.PH_GENERIC_NAME' | translate" />
      </div>
    </div>
    <div class="form-row">
      <div class="form-field">
        <label class="field-label">{{ 'MEDICINES.CATEGORY' | translate }}</label>
        <p-select [options]="categoryOptions()" [(ngModel)]="form.categoryId"
                  [placeholder]="'MEDICINES.PH_ALL_CATEGORIES' | translate" [showClear]="true" />
      </div>
      <div class="form-field">
        <label class="field-label">{{ 'MEDICINES.UNIT' | translate }}</label>
        <input pInputText [(ngModel)]="form.unit" [placeholder]="'MEDICINES.PH_UNIT' | translate" />
      </div>
    </div>
    <div class="form-row">
      <div class="form-field">
        <label class="field-label">{{ 'MEDICINES.BARCODE' | translate }}</label>
        <input pInputText [(ngModel)]="form.barcode" [placeholder]="'MEDICINES.PH_BARCODE' | translate" />
      </div>
      <div class="form-field">
        <label class="field-label">{{ 'MEDICINES.REORDER_LEVEL' | translate }}</label>
        <p-inputNumber [(ngModel)]="form.reorderLevel" [min]="0" [showButtons]="true" />
      </div>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button [label]="'COMMON.CANCEL' | translate" severity="secondary" [outlined]="true"
              (onClick)="showDialog.set(false)" />
    <p-button [label]="(editMode() ? 'COMMON.SAVE' : 'COMMON.CREATE') | translate" icon="pi pi-check"
              (onClick)="save()" [loading]="saving()" />
  </ng-template>
</p-dialog>
